<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Gym Workout Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #000000;
      color: #f5f5f5;
      padding: 16px;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
      user-select: none;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding-bottom: 64px;
    }

    header {
      margin-bottom: 16px;
    }

    h1 {
      font-size: 2.2rem;
      margin-bottom: 4px;
    }

    .date {
      font-size: 0.95rem;
      opacity: 0.85;
    }

    .notes {
      margin-top: 6px;
      font-size: 1rem;
      opacity: 0.9;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #f5f5f5;
      padding: 4px 10px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .btn-small {
      font-size: 0.75rem;
      padding: 3px 8px;
    }

    .btn-primary {
      background: #166534;
      border-color: #22c55e;
      color: #e5ffe9;
    }

    .btn-outline {
      background: transparent;
    }

    .status {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .section-title {
      margin-top: 16px;
      margin-bottom: 4px;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.9;
    }

    .card {
      background: #050509;
      border-radius: 14px;
      padding: 12px 14px;
      margin-top: 8px;
      border: 1px solid #1f2933;
    }

    .warmup-desc {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    ul {
      list-style: disc;
      margin-left: 18px;
      font-size: 0.9rem;
    }

    /* ACCORDION BLOCKS */

    .block-card {
      margin-top: 8px;
      overflow: hidden;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .block-card.active {
      border-color: #22c55e;
      background: #020617;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .block-header-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .block-name {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .block-type {
      font-size: 0.75rem;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .block-instructions {
      font-size: 0.85rem;
      opacity: 0.85;
      margin-top: 4px;
    }

    .block-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .rest-label {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .block-body {
      margin-top: 8px;
      border-top: 1px solid #111827;
      padding-top: 6px;
      display: none;
    }

    .block-card.active .block-body {
      display: block;
    }

    /* EXERCISES */

    .exercise {
      padding: 6px 0;
      border-bottom: 1px solid #111827;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    .exercise:last-child {
      border-bottom: none;
    }

    .exercise-left {
      flex: 1;
      min-width: 0;
    }

    .exercise-name {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .exercise-meta {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 1px;
    }

    .exercise-notes {
      font-size: 0.8rem;
      opacity: 0.75;
      margin-top: 2px;
    }

    .exercise-right {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      flex-shrink: 0;
    }

    .check-circle {
      height: 18px;
      width: 18px;
      border-radius: 999px;
      border: 2px solid #4b5563;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #22c55e;
      opacity: 0;
      transition: opacity 0.15s ease, border-color 0.15s ease;
    }

    .exercise.completed {
      opacity: 0.45;
    }

    .exercise.completed .check-circle {
      opacity: 1;
      border-color: #22c55e;
    }

    /* TIMER OVERLAY */

    #timer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.92);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      gap: 16px;
      text-align: center;
      padding: 20px;
    }

    #timer-overlay.active {
      display: flex;
    }

    #timer-label {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    #timer-value {
      font-size: 4.2rem;
      font-weight: 700;
    }

    #timer-subtext {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .timer-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .error {
      margin-top: 10px;
      color: #fecaca;
      font-size: 0.85rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top-bar">
      <div id="status-text" class="status">Loading workout...</div>
      <div class="controls">
        <button class="btn btn-outline btn-small" onclick="loadWorkout(true)">Refresh</button>
        <button class="btn btn-outline btn-small" onclick="requestWakeLock()">Keep Awake</button>
      </div>
    </div>

    <header>
      <h1 id="title">Workout</h1>
      <div id="date" class="date"></div>
      <div id="notes" class="notes"></div>
    </header>

    <section id="warmup-section"></section>
    <section id="blocks-section"></section>

    <div id="error" class="error"></div>
  </div>

  <!-- TIMER OVERLAY -->
  <div id="timer-overlay">
    <div id="timer-label">Rest</div>
    <div id="timer-value">00:00</div>
    <div id="timer-subtext"></div>
    <div class="timer-controls">
      <button class="btn btn-primary btn-small" onclick="stopTimer()">Done</button>
      <button class="btn btn-outline btn-small" onclick="stopTimer()">Cancel</button>
    </div>
  </div>

  <script>
    const COMPLETION_PREFIX = "gymDisplay_v2_";
    let wakeLockSentinel = null;
    let currentWorkoutDate = null;
    let timerInterval = null;
    let timerRemaining = 0;

    /* ------------------------------
       LOAD WORKOUT.JSON
    ------------------------------ */

    async function loadWorkout(showStatus) {
      const status = document.getElementById("status-text");
      const error = document.getElementById("error");
      error.textContent = "";

      if (showStatus) status.textContent = "Refreshing...";

      try {
        const res = await fetch("workout.json?t=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        renderWorkout(data);

        status.textContent = "Workout loaded";
      } catch (err) {
        console.error(err);
        error.textContent = "Error loading workout.json";
        status.textContent = "Load error";
      }
    }

    /* ------------------------------
       RENDER WORKOUT
    ------------------------------ */

    function renderWorkout(data) {
      const titleEl = document.getElementById("title");
      const dateEl = document.getElementById("date");
      const notesEl = document.getElementById("notes");
      const warmupSection = document.getElementById("warmup-section");
      const blocksSection = document.getElementById("blocks-section");

      currentWorkoutDate = data.date || "unknown";

      titleEl.textContent = data.title || "Workout";
      dateEl.textContent = data.date ? "Date: " + data.date : "";
      notesEl.textContent = data.notes || "";

      warmupSection.innerHTML = "";
      blocksSection.innerHTML = "";

      /* WARMUP */
      if (data.warmup) {
        const warmTitle = document.createElement("h2");
        warmTitle.className = "section-title";
        warmTitle.textContent = "Warmup";
        warmupSection.appendChild(warmTitle);

        const warmCard = document.createElement("div");
        warmCard.className = "card";

        if (data.warmup.description) {
          const desc = document.createElement("div");
          desc.className = "warmup-desc";
          desc.textContent = data.warmup.description;
          warmCard.appendChild(desc);
        }

        if (Array.isArray(data.warmup.items)) {
          const ul = document.createElement("ul");
          data.warmup.items.forEach(i => {
            const li = document.createElement("li");
            li.textContent = i;
            ul.appendChild(li);
          });
          warmCard.appendChild(ul);
        }

        warmupSection.appendChild(warmCard);
      }

      /* MAIN WORK BLOCKS */
      if (Array.isArray(data.blocks)) {
        const blocksTitle = document.createElement("h2");
        blocksTitle.className = "section-title";
        blocksTitle.textContent = "Main Work";
        blocksSection.appendChild(blocksTitle);

        data.blocks.forEach((block, idx) => {
          const blockId = block.id || "block_" + idx;
          const card = document.createElement("div");
          card.className = "card block-card";
          card.dataset.blockId = blockId;

          /* HEADER */
          const header = document.createElement("div");
          header.className = "block-header";

          const headerMain = document.createElement("div");
          headerMain.className = "block-header-main";

          const name = document.createElement("div");
          name.className = "block-name";
          name.textContent = block.name || "Block";

          const type = document.createElement("div");
          type.className = "block-type";
          type.textContent = block.type || "";

          headerMain.appendChild(name);
          headerMain.appendChild(type);

          const headerRight = document.createElement("div");
          headerRight.className = "block-header-right";

          if (block.rest_seconds) {
            const restLabel = document.createElement("div");
            restLabel.className = "rest-label";
            restLabel.textContent = `${block.rest_seconds} sec rest`;
            headerRight.appendChild(restLabel);

            const restBtn = document.createElement("button");
            restBtn.className = "btn btn-outline btn-small";
            restBtn.textContent = "Start Rest";
            restBtn.onclick = (e) => {
              e.stopPropagation();
              startTimer(block.rest_seconds, block.name);
            };
            headerRight.appendChild(restBtn);
          }

          header.appendChild(headerMain);
          header.appendChild(headerRight);
          card.appendChild(header);

          /* INSTRUCTIONS */
          if (block.instructions) {
            const inst = document.createElement("div");
            inst.className = "block-instructions";
            inst.textContent = block.instructions;
            card.appendChild(inst);
          }

          /* BODY */
          const body = document.createElement("div");
          body.className = "block-body";

          (block.exercises || []).forEach((ex, exIdx) => {
            const exDiv = document.createElement("div");
            exDiv.className = "exercise";
            exDiv.dataset.blockId = blockId;
            exDiv.dataset.exerciseIndex = exIdx;

            const left = document.createElement("div");
            left.className = "exercise-left";

            const exName = document.createElement("div");
            exName.className = "exercise-name";
            exName.textContent = ex.name || "";
            left.appendChild(exName);

            const meta = [];
            if (ex.sets) meta.push(`${ex.sets} sets`);
            if (ex.reps) meta.push(`${ex.reps} reps`);
            if (ex.load) meta.push(ex.load);

            if (meta.length) {
              const exMeta = document.createElement("div");
              exMeta.className = "exercise-meta";
              exMeta.textContent = meta.join(" · ");
              left.appendChild(exMeta);
            }

            if (ex.notes) {
              const exNotes = document.createElement("div");
              exNotes.className = "exercise-notes";
              exNotes.textContent = ex.notes;
              left.appendChild(exNotes);
            }

            const right = document.createElement("div");
            right.className = "exercise-right";
            const circle = document.createElement("div");
            circle.className = "check-circle";
            circle.textContent = "✓";
            right.appendChild(circle);

            exDiv.appendChild(left);
            exDiv.appendChild(right);

            exDiv.onclick = () => toggleExercise(exDiv);
            if (isCompleted(currentWorkoutDate, blockId, exIdx)) {
              exDiv.classList.add("completed");
            }

            body.appendChild(exDiv);
          });

          card.appendChild(body);

          header.onclick = () => activateBlock(blockId);
          blocksSection.appendChild(card);
        });

        const first = blocksSection.querySelector(".block-card");
        if (first) first.classList.add("active");
      }
    }

    /* ------------------------------
       COMPLETION STORAGE
    ------------------------------ */

    function keyFor(date, block, exIdx) {
      return `${COMPLETION_PREFIX}${date}_${block}_${exIdx}`;
    }

    function isCompleted(date, block, exIdx) {
      return localStorage.getItem(keyFor(date, block, exIdx)) === "1";
    }

    function toggleExercise(div) {
      const block = div.dataset.blockId;
      const idx = div.dataset.exerciseIndex;
      const key = keyFor(currentWorkoutDate, block, idx);

      const done = div.classList.toggle("completed");
      if (done) localStorage.setItem(key, "1");
      else localStorage.removeItem(key);
    }

    function activateBlock(blockId) {
      document.querySelectorAll(".block-card").forEach(c => {
        c.classList.toggle("active", c.dataset.blockId === blockId);
      });
    }

    /* ------------------------------
       REST TIMER
    ------------------------------ */

    function startTimer(seconds, label) {
      const overlay = document.getElementById("timer-overlay");
      const value = document.getElementById("timer-value");
      const labelEl = document.getElementById("timer-label");
      const sub = document.getElementById("timer-subtext");

      if (timerInterval) clearInterval(timerInterval);
      timerRemaining = seconds;

      labelEl.textContent = label;
      sub.textContent = "Breathe. Recover. Lock in.";
      value.textContent = formatTime(timerRemaining);

      overlay.classList.add("active");

      timerInterval = setInterval(() => {
        timerRemaining--;
        if (timerRemaining <= 0) {
          value.textContent = "00:00";
          sub.textContent = "Rest complete.";
          clearInterval(timerInterval);
          timerInterval = null;
        } else {
          value.textContent = formatTime(timerRemaining);
        }
      }, 1000);
    }

    function stopTimer() {
      document.getElementById("timer-overlay").classList.remove("active");
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }

    function formatTime(s) {
      const m = Math.floor(s / 60);
      const sec = s % 60;
      return `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
    }

    /* ------------------------------
       WAKE LOCK
    ------------------------------ */

    async function requestWakeLock() {
      const status = document.getElementById("status-text");

      if (!("wakeLock" in navigator)) {
        status.textContent = "Wake lock not supported. Use Guided Access.";
        return;
      }

      try {
        wakeLockSentinel = await navigator.wakeLock.request("screen");
        status.textContent = "Screen awake";
        wakeLockSentinel.addEventListener("release", () => {
          status.textContent = "Wake lock released";
        });
      } catch (err) {
        status.textContent = "Wake lock failed";
      }
    }

    /* ------------------------------
       INIT
    ------------------------------ */

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible" && wakeLockSentinel) {
        requestWakeLock();
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadWorkout(false);
    });
  </script>
</body>
</html>
