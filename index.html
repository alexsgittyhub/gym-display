<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GymOS v3.3 (Stable)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Roboto+Mono:wght@400;500&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505; 
            --card-bg: #141414;
            --card-border: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --accent: #D4FF00; /* Acid Green */
            --accent-dim: rgba(212, 255, 0, 0.15);
            --watch-blue: #5ac8fa; /* Apple Watch Blue */
            --watch-bg: rgba(90, 200, 250, 0.1);
            --danger: #FF2E2E;
            
            --font-head: 'Oswald', sans-serif;
            --font-body: 'Roboto', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-body);
            padding-bottom: 140px; 
        }

        /* Progress Bar */
        #progress-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: #222; z-index: 1000;
        }
        #progress-fill {
            height: 100%; background: var(--accent); width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        /* Header */
        header {
            padding: 24px 20px;
            background: linear-gradient(180deg, rgba(20,20,20,1) 0%, rgba(5,5,5,0) 100%);
            display: flex; justify-content: space-between; align-items: start;
        }
        
        .header-content h1 {
            font-family: var(--font-head);
            text-transform: uppercase;
            font-size: 2.2rem; margin: 0; line-height: 1;
            letter-spacing: 1px;
        }
        .header-content .date {
            font-family: var(--font-mono);
            color: var(--accent);
            font-size: 0.85rem; margin-top: 6px; letter-spacing: 1px;
        }

        .refresh-btn {
            background: transparent; border: 1px solid var(--card-border);
            color: var(--text-secondary); padding: 8px 12px;
            border-radius: 4px; font-family: var(--font-mono);
            font-size: 0.8rem; text-transform: uppercase;
        }

        /* Layout */
        .container { padding: 0 16px; }

        /* Warmup Card - BIG TEXT FIX */
        .warmup-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 20px; margin-bottom: 24px;
            border-left: 4px solid var(--watch-blue);
        }
        .warmup-label {
            font-family: var(--font-mono); color: var(--watch-blue);
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 12px; display: block;
        }
        .warmup-item {
            color: #fff; padding: 8px 0; 
            font-size: 1.4rem; /* INCREASED SIZE */
            font-weight: 500;
            border-bottom: 1px solid #222;
            line-height: 1.3;
        }
        .warmup-item:last-child { border-bottom: none; }

        /* Block Headers */
        .block-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 4px; margin-top: 10px;
            border-bottom: 2px solid var(--card-border);
            margin-bottom: 16px;
        }
        .block-title {
            font-family: var(--font-head); font-size: 1.8rem;
            text-transform: uppercase; color: #fff;
        }
        .timer-badge {
            background: #222; color: var(--accent);
            border: 1px solid var(--accent);
            font-family: var(--font-mono); font-weight: bold;
            padding: 4px 10px; border-radius: 4px;
            font-size: 0.9rem; display: flex; align-items: center; gap: 6px;
        }

        /* Apple Watch Alert Box */
        .watch-alert {
            display: flex; align-items: center; gap: 12px;
            background: var(--watch-bg);
            border-left: 3px solid var(--watch-blue);
            padding: 10px 14px;
            border-radius: 0 6px 6px 0;
            margin-bottom: 16px;
            color: #fff;
        }
        .watch-icon { font-size: 1.4rem; }
        .watch-text { font-family: var(--font-mono); font-size: 0.9rem; color: var(--watch-blue); }

        /* Exercises */
        .exercise-card {
            background: var(--card-bg);
            border-left: 4px solid var(--card-border);
            border-radius: 4px;
            margin-bottom: 16px; padding: 16px;
            position: relative; transition: all 0.2s;
        }

        .exercise-card.completed {
            border-left-color: var(--accent);
            background: #1a1f10; 
            opacity: 0.8;
        }
        .exercise-card.completed .ex-name {
            text-decoration: line-through; color: #666;
        }

        .ex-top { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .ex-name {
            font-size: 1.3rem; font-weight: 700; margin-bottom: 4px;
            line-height: 1.2; width: 65%;
        }

        .load-pill {
            background: var(--accent-dim); color: var(--accent);
            font-family: var(--font-mono); font-weight: 700;
            padding: 6px 12px; border-radius: 4px;
            font-size: 1.1rem; cursor: pointer;
            border: 1px solid transparent;
            text-align: right;
        }
        .load-pill:active { transform: scale(0.95); }

        .ex-details {
            font-family: var(--font-mono); color: var(--text-secondary);
            font-size: 0.95rem; margin-top: 4px;
        }

        .ex-notes {
            margin-top: 10px; font-size: 0.9rem; color: #888;
            font-style: italic; background: #000; padding: 8px;
            border-radius: 4px;
        }

        /* Input Areas */
        .log-area {
            margin-top: 12px; padding-top: 12px;
            border-top: 1px solid #222;
            display: flex; align-items: center; justify-content: flex-end; gap: 10px;
        }
        
        /* The standard Strength Input */
        .log-input {
            background: #000; border: 1px solid #333;
            color: #fff; padding: 8px; border-radius: 4px;
            width: 80px; text-align: center; font-family: var(--font-mono);
            font-size: 1rem;
        }
        .log-input:focus { border-color: var(--accent); outline: none; }

        /* Run Inputs */
        .run-input-group {
            display: flex; gap: 8px; width: 100%; justify-content: flex-end;
        }
        .input-labeled { position: relative; }
        .input-labeled input { width: 90px; padding-right: 5px; }
        .unit-label { 
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            font-size: 0.7rem; color: #555; pointer-events: none;
        }

        /* Footer Action Bar */
        #action-bar {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 90;
        }
        
        .action-btn {
            background: var(--card-bg); border: 1px solid var(--card-border);
            color: #fff; padding: 12px 20px; border-radius: 50px;
            font-family: var(--font-head); text-transform: uppercase;
            letter-spacing: 1px; font-size: 1rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            display: flex; align-items: center; gap: 8px;
        }
        
        #btn-publish { background: var(--accent); color: #000; border: none; font-weight: bold; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
        }
        
        .timer-big { font-family: var(--font-mono); font-size: 6rem; font-weight: 700; color: #fff; }
        .timer-controls { display: flex; gap: 20px; margin-top: 30px; }
        .circle-btn {
            width: 70px; height: 70px; border-radius: 50%;
            border: 2px solid #333; background: transparent;
            color: #fff; font-size: 1.5rem; display: flex; justify-content: center; align-items: center;
        }
        .btn-stop { border-color: var(--danger); color: var(--danger); }
        
        /* Plate Math */
        .plate-display { text-align: center; padding: 20px; }
        .plate-header { font-family: var(--font-head); font-size: 2rem; margin-bottom: 20px; color: var(--accent); }
        .plate-visual { display: flex; gap: 4px; justify-content: center; align-items: center; margin-bottom: 20px; }
        .plate {
            height: 80px; width: 20px; background: #333; border: 1px solid #555; border-radius: 4px;
            display: flex; justify-content: center; align-items: center; font-size: 0.7rem; color: #000; writing-mode: vertical-rl;
        }
        .p-45 { background: #0044ff; height: 100px; width: 25px; } 
        .p-35 { background: #ffcc00; height: 90px; }
        .p-25 { background: #00cc44; height: 80px; }
        .p-10 { background: #eee; height: 60px; }
        .p-5 { background: #eee; height: 40px; }
        .p-2_5 { background: #555; height: 30px; }
        .plate-text { font-family: var(--font-mono); font-size: 1.2rem; color: #ccc; }
    </style>
</head>
<body>

    <div id="progress-container"><div id="progress-fill"></div></div>

    <header>
        <div class="header-content">
            <div class="date" id="date-display">LOADING SYSTEM...</div>
            <h1 id="title-display">...</h1>
        </div>
        <button class="refresh-btn" onclick="window.location.reload()">SYNC</button>
    </header>

    <div id="app-content" class="container"></div>

    <div id="action-bar">
        <button class="action-btn" onclick="toggleWakeLock()">üí° Screen</button>
        <button class="action-btn" id="btn-publish" onclick="copyLogsToClipboard()">
            <span>üìã</span> Log Result
        </button>
    </div>

    <div id="timer-modal" class="modal-overlay">
        <div class="timer-big" id="timer-val">00:00</div>
        <div class="timer-controls">
            <button class="circle-btn" onclick="adjustTimer(-10)">-10</button>
            <button class="circle-btn" onclick="adjustTimer(+10)">+10</button>
        </div>
        <br>
        <button class="action-btn btn-stop" onclick="closeTimer()">STOP</button>
    </div>

    <div id="plate-modal" class="modal-overlay" onclick="closePlateModal()">
        <div class="plate-display" onclick="event.stopPropagation()">
            <div class="plate-header" id="plate-target-weight">225 lbs</div>
            <div class="plate-visual" id="plate-graphic"></div>
            <div class="plate-text" id="plate-list"></div>
            <br><br>
            <div style="color:#666; font-size:0.8rem">(Tap anywhere to close)</div>
        </div>
    </div>

    <script>
        const DATA_URL = 'workout.json';
        let currentTimerInterval = null;
        let wakeLock = null;
        let totalExercises = 0;

        // --- DEMO DATA: SHOWS ALL 3 STATES (Lift, Run, Mobility) ---
        const DEMO_DATA = {
            date: "DEMO MODE",
            title: "GYMOS v3.3",
            warmup: {
                description: "Test Sequence:",
                items: ["5 min Run", "20 Air Squats", "Shoulder Dislocates"]
            },
            blocks: [
                {
                    name: "Strength",
                    exercises: [
                        { name: "Barbell Squat", sets: 3, reps: 5, load: "225 lbs", type: "lift" }
                    ]
                },
                {
                    name: "Conditioning",
                    exercises: [
                        { name: "Interval Run", type: "run", notes: "Hard pace" }
                    ]
                },
                {
                    name: "Cooldown",
                    exercises: [
                        { name: "Child's Pose", type: "mobility", notes: "Hold for 2 mins" } // Should NOT show input
                    ]
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadWorkout();
            requestWakeLock();
        });

        async function loadWorkout() {
            try {
                const res = await fetch(`${DATA_URL}?t=${Date.now()}`); 
                if(!res.ok) throw new Error("No workout file");
                const data = await res.json();
                render(data);
            } catch (e) {
                console.log("Using Demo Data due to fetch error.");
                render(DEMO_DATA);
            }
        }

        function render(data) {
            document.getElementById('date-display').innerText = data.date || new Date().toLocaleDateString();
            document.getElementById('title-display').innerText = data.title || "WORKOUT";
            
            const container = document.getElementById('app-content');
            container.innerHTML = '';
            totalExercises = 0;

            // 1. Warmup
            if(data.warmup) {
                const wCard = document.createElement('div');
                wCard.className = 'warmup-card';
                let html = `<span class="warmup-label">WARMUP PROTOCOL</span>`;
                html += `<div style="margin-bottom:10px; color:#aaa; font-size:0.9rem;">${data.warmup.description || ''}</div>`;
                (data.warmup.items || []).forEach(item => {
                    html += `<div class="warmup-item">${item}</div>`;
                });
                wCard.innerHTML = html;
                container.appendChild(wCard);
            }

            // 2. Blocks
            (data.blocks || []).forEach(block => {
                // Header
                const bHead = document.createElement('div');
                bHead.className = 'block-header';
                let timerHtml = '';
                if(block.rest_seconds) {
                    timerHtml = `<div class="timer-badge" onclick="startTimer(${block.rest_seconds})">‚è± ${block.rest_seconds}s</div>`;
                }
                bHead.innerHTML = `<span class="block-title">${block.name}</span>${timerHtml}`;
                container.appendChild(bHead);

                if(block.apple_watch) {
                    const watchDiv = document.createElement('div');
                    watchDiv.className = 'watch-alert';
                    watchDiv.innerHTML = `<div class="watch-icon">‚åö</div><div class="watch-text">${block.apple_watch}</div>`;
                    container.appendChild(watchDiv);
                }

                if(block.instructions) {
                    const instr = document.createElement('div');
                    instr.style.cssText = "color:var(--text-secondary); margin-bottom:15px; font-family:var(--font-mono); font-size:0.9rem";
                    instr.innerText = `// ${block.instructions}`;
                    container.appendChild(instr);
                }

                // Exercises
                (block.exercises || []).forEach(ex => {
                    totalExercises++;
                    const exCard = document.createElement('div');
                    exCard.className = 'exercise-card';
                    
                    // Default to 'lift' if type is missing, for backward compatibility
                    const type = (ex.type || 'lift').toLowerCase();
                    
                    exCard.dataset.type = type;
                    exCard.dataset.name = ex.name;
                    exCard.onclick = (e) => toggleComplete(exCard, e);

                    // --- INPUT LOGIC START ---
                    let inputHtml = '';
                    let loadPill = '';

                    // CASE 1: RUN (Time & Incline)
                    if(type === 'run') {
                         inputHtml = `
                            <div style="margin-top:12px; border-top:1px solid #222; padding-top:12px;">
                                <div class="run-input-group">
                                    <div class="input-labeled">
                                        <input type="text" class="log-input run-time" placeholder="Time" onclick="event.stopPropagation()">
                                        <span class="unit-label">m:s</span>
                                    </div>
                                    <div class="input-labeled">
                                        <input type="number" class="log-input run-incline" placeholder="Inc" step="0.5" onclick="event.stopPropagation()">
                                        <span class="unit-label">%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } 
                    // CASE 2: MOBILITY / BODYWEIGHT (No Inputs)
                    else if(type === 'mobility' || type === 'bodyweight') {
                        // Ensure we have an empty pill to keep layout consistent if needed, or nothing.
                        // We do NOT render the inputHtml block here.
                        inputHtml = ''; 
                    }
                    // CASE 3: LIFT / STRENGTH (Default)
                    else {
                        const loadString = ex.load || "-";
                        const isCalculable = /\d+/.test(loadString) && (loadString.includes('lb') || !isNaN(loadString));
                        const loadAttr = isCalculable ? `onclick="showPlateMath('${loadString}', event)"` : '';
                        
                        loadPill = `<div class="load-pill" ${loadAttr}>${loadString}</div>`;
                        
                        // The original v3.1 "Log Actual" field
                        inputHtml = `
                            <div class="log-area">
                                <span style="font-size:0.7rem; color:#444">LOG LOAD:</span>
                                <input type="text" class="log-input strength-weight" placeholder="e.g. 280" onclick="event.stopPropagation()">
                            </div>
                        `;
                    }
                    // --- INPUT LOGIC END ---

                    exCard.innerHTML = `
                        <div class="ex-top">
                            <div class="ex-name">${ex.name}</div>
                            ${loadPill}
                        </div>
                        <div class="ex-details">
                            ${ex.sets ? ex.sets + ' SETS' : ''}  
                            ${ex.reps ? 'x ' + ex.reps : ''}
                        </div>
                        ${ex.notes ? `<div class="ex-notes">${ex.notes}</div>` : ''}
                        ${inputHtml}
                    `;
                    container.appendChild(exCard);
                });
            });
        }

        function toggleComplete(card, e) {
            if(e.target.tagName === 'INPUT' || e.target.classList.contains('load-pill')) return;
            card.classList.toggle('completed');
            updateProgress();
        }

        function updateProgress() {
            const completed = document.querySelectorAll('.exercise-card.completed').length;
            const pct = (completed / totalExercises) * 100;
            document.getElementById('progress-fill').style.width = `${pct}%`;
        }

        function copyLogsToClipboard() {
            let txt = `Workout Log [${document.getElementById('date-display').innerText}]:\n`;
            
            const cards = document.querySelectorAll('.exercise-card');
            let found = false;

            cards.forEach(card => {
                const name = card.dataset.name;
                const type = card.dataset.type;

                // Handle Run
                if(type === 'run') {
                    const time = card.querySelector('.run-time').value;
                    const inc = card.querySelector('.run-incline').value;
                    if(time || inc) {
                        txt += `- ${name}: ${time || '0'} mins @ ${inc || '0'}%\n`;
                        found = true;
                    }
                } 
                // Handle Lift
                else if (type === 'lift' || !type || type === 'strength') {
                    // Check if input exists (it won't on mobility)
                    const input = card.querySelector('.strength-weight');
                    if(input && input.value.trim() !== '') {
                        txt += `- ${name}: ${input.value}\n`;
                        found = true;
                    }
                }
                // Mobility is ignored in logs unless you want to just say "Completed"
            });

            if(!found) txt += "Session Completed.";
            
            navigator.clipboard.writeText(txt).then(() => {
                const btn = document.getElementById('btn-publish');
                const old = btn.innerHTML;
                btn.innerHTML = "‚úÖ COPIED";
                setTimeout(() => btn.innerHTML = old, 2000);
            });
        }

        // --- PLATE MATH & UTILS ---
        function showPlateMath(loadStr, e) {
            e.stopPropagation();
            const match = loadStr.match(/(\d+)/);
            if(!match) return;
            const weight = parseInt(match[0]);
            if(weight < 45) return; 

            const target = (weight - 45) / 2;
            const plates = [45, 35, 25, 10, 5, 2.5];
            let remaining = target;
            let result = [];
            
            plates.forEach(p => {
                while(remaining >= p) {
                    result.push(p);
                    remaining -= p;
                }
            });

            document.getElementById('plate-target-weight').innerText = `${weight} lbs`;
            
            const counts = {};
            result.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
            let text = Object.entries(counts).map(([k,v]) => `${v} x ${k}`).join(' | ');
            if(result.length === 0) text = "Empty Bar";
            document.getElementById('plate-list').innerText = `Per Side: ${text}`;

            let html = `<div class="plate" style="background:#555; width:10px; height:120px;"></div>`; 
            result.forEach(p => {
                let cls = 'p-' + p.toString().replace('.','_');
                html += `<div class="plate ${cls}">${p}</div>`;
            });
            document.getElementById('plate-graphic').innerHTML = html;

            document.getElementById('plate-modal').style.display = 'flex';
        }

        function closePlateModal() { document.getElementById('plate-modal').style.display = 'none'; }

        let timerSeconds = 0;
        function startTimer(sec) {
            timerSeconds = sec;
            document.getElementById('timer-modal').style.display = 'flex';
            tick();
            if(currentTimerInterval) clearInterval(currentTimerInterval);
            currentTimerInterval = setInterval(tick, 1000);
        }

        function tick() {
            timerSeconds--;
            const m = Math.floor(timerSeconds / 60).toString().padStart(2,'0');
            const s = (timerSeconds % 60).toString().padStart(2,'0');
            document.getElementById('timer-val').innerText = `${m}:${s}`;
            if(timerSeconds <= 0) {
                document.getElementById('timer-val').style.color = 'var(--accent)';
                clearInterval(currentTimerInterval);
            }
        }

        function adjustTimer(amt) { timerSeconds += amt; tick(); }
        function closeTimer() { document.getElementById('timer-modal').style.display = 'none'; if(currentTimerInterval) clearInterval(currentTimerInterval); }

        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); }
        }
        function toggleWakeLock() { if(!wakeLock) requestWakeLock(); else alert("Screen Lock Active"); }
    </script>
</body>
</html>
