<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Display</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #121212;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #00ff9d; /* Neon Green */
            --accent-dim: rgba(0, 255, 157, 0.1);
            --border: #333333;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-main);
            padding-bottom: 120px; /* Extra space for floating button */
        }

        /* Header */
        header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        h1 { margin: 0; font-size: 1.8rem; font-weight: 700; letter-spacing: -0.5px; line-height: 1.2; }
        .meta { font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; }

        /* Refresh Button */
        .refresh-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Warmup Section */
        .warmup {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        .warmup h2 { font-size: 1.2rem; color: var(--accent); margin-top: 0; margin-bottom: 10px; }
        .warmup-item { color: var(--text-secondary); margin-bottom: 5px; font-size: 1rem; }

        /* Blocks (Accordion) */
        .block {
            border-bottom: 1px solid var(--border);
        }
        
        .block-header {
            padding: 20px;
            background: var(--bg-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .block-title { font-size: 1.4rem; font-weight: 600; }
        .block-meta { font-size: 0.9rem; color: var(--text-secondary); }
        .chevron { transition: transform 0.2s; }
        .block.open .chevron { transform: rotate(180deg); }

        .block-content {
            display: none;
            padding: 0 20px 20px 20px;
            background: var(--bg-color);
        }
        .block.open .block-content { display: block; }

        /* Rest Timer Button */
        .timer-trigger {
            background: var(--accent-dim);
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
            font-weight: bold;
        }

        /* Exercises */
        .exercise {
            background: var(--card-bg);
            margin-bottom: 12px;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exercise.completed {
            border-color: var(--accent);
            background: #0a1a12;
        }
        
        .exercise.completed .ex-name {
            color: var(--accent);
            text-decoration: line-through;
        }

        .ex-info { flex-grow: 1; padding-right: 10px; }
        .ex-header { display: flex; justify-content: space-between; align-items: baseline; }
        .ex-name { font-size: 1.3rem; font-weight: 600; margin-bottom: 5px; }
        .ex-details { font-size: 1.1rem; color: var(--text-secondary); }
        .ex-load { color: var(--accent); font-weight: 600; margin-left: 10px; white-space: nowrap; }
        .ex-notes { font-size: 0.95rem; color: #888; margin-top: 5px; font-style: italic; }

        /* Logging Input */
        .log-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .log-input {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 10px 5px;
            width: 70px;
            border-radius: 6px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .log-input:focus {
            border-color: var(--accent);
            outline: none;
            background: #333;
        }
        .log-label {
            font-size: 0.7rem;
            color: #666;
            margin-top: 4px;
        }

        /* Error Box */
        #error-container {
            display: none;
            padding: 20px;
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            margin: 20px;
            border-radius: 8px;
            border: 1px solid #ff4444;
            white-space: pre-wrap;
            font-family: monospace;
        }

        /* Full Screen Timer Overlay */
        #timer-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #timer-display { font-size: 6rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        #timer-controls { margin-top: 20px; }
        .timer-btn {
            padding: 15px 30px; font-size: 1.2rem; border-radius: 50px;
            border: none; background: #333; color: white; margin: 0 10px;
            cursor: pointer;
        }
        .btn-close { background: #ff4444; color: white; }

        /* Floating Copy Button */
        #copy-logs-btn {
            position: fixed;
            bottom: 30px;
            right: 20px;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,255,157,0.4);
            cursor: pointer;
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        #copy-logs-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <header>
        <div>
            <div class="meta" id="date-display">Loading...</div>
            <h1 id="title-display">...</h1>
        </div>
        <button class="refresh-btn" onclick="loadWorkout()">Refresh</button>
    </header>

    <div id="error-container"></div>

    <div id="app-content">
        <!-- Content injected here -->
    </div>
    
    <button id="copy-logs-btn" onclick="copyLogsToClipboard()">
        <span>üìã</span> Copy Results for ChatGPT
    </button>

    <!-- Timer Overlay -->
    <div id="timer-overlay">
        <div id="timer-display">00:00</div>
        <div id="timer-controls">
            <button class="timer-btn btn-close" onclick="closeTimer()">Close</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const DATA_URL = 'workout.json';
        
        // --- APP STATE ---
        let currentTimer = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkout();
            setupWakeLock();
        });

        // --- WAKE LOCK (Keep screen on) ---
        async function setupWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }

        // --- DATA LOADING ---
        async function loadWorkout() {
            const errorBox = document.getElementById('error-container');
            const appContent = document.getElementById('app-content');
            
            // UI Reset
            errorBox.style.display = 'none';
            appContent.innerHTML = '<div style="padding:40px; text-align:center; color:#666">Fetching workout plan...</div>';

            try {
                // Cache busting: Append timestamp to URL
                const response = await fetch(`${DATA_URL}?t=${new Date().getTime()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                renderApp(data);

            } catch (err) {
                appContent.innerHTML = '';
                errorBox.style.display = 'block';
                errorBox.textContent = `ERROR LOADING WORKOUT:\n${err.message}\n\nTroubleshooting:\n1. Is 'workout.json' in the repo root?\n2. Is the file name lowercase?\n3. Is the JSON valid?`;
            }
        }

        // --- RENDERING ---
        function renderApp(data) {
            document.getElementById('date-display').textContent = data.date || new Date().toLocaleDateString();
            document.getElementById('title-display').textContent = data.title || 'Workout';
            
            const container = document.getElementById('app-content');
            container.innerHTML = '';

            // 1. Warmup
            if (data.warmup) {
                const wDiv = document.createElement('div');
                wDiv.className = 'warmup';
                let html = `<h2>Warmup</h2><p style="color:#888; font-size:0.95rem; margin-top:-5px; line-height:1.4">${data.warmup.description || ''}</p>`;
                if (data.warmup.items) {
                    data.warmup.items.forEach(item => {
                        html += `<div class="warmup-item">‚Ä¢ ${item}</div>`;
                    });
                }
                wDiv.innerHTML = html;
                container.appendChild(wDiv);
            }

            // 2. Blocks
            if (data.blocks) {
                data.blocks.forEach((block, index) => {
                    const bDiv = document.createElement('div');
                    bDiv.className = `block ${index === 0 ? 'open' : ''}`;
                    bDiv.id = `block-${index}`;

                    // Header
                    const header = document.createElement('div');
                    header.className = 'block-header';
                    
                    let timerBtn = '';
                    if (block.rest_seconds) {
                        timerBtn = `<span class="timer-trigger" onclick="event.stopPropagation(); startTimer(${block.rest_seconds})">‚è± ${block.rest_seconds}s</span>`;
                    }

                    header.innerHTML = `
                        <div>
                            <span class="block-title">${block.name}</span>
                            ${timerBtn}
                            <div class="block-meta">${block.instructions || ''}</div>
                        </div>
                        <div class="chevron">‚ñº</div>
                    `;
                    
                    header.onclick = () => {
                        document.querySelectorAll('.block').forEach(b => { if (b !== bDiv) b.classList.remove('open'); });
                        bDiv.classList.toggle('open');
                    };

                    // Exercises
                    const content = document.createElement('div');
                    content.className = 'block-content';
                    
                    if (block.exercises) {
                        block.exercises.forEach(ex => {
                            const exDiv = document.createElement('div');
                            exDiv.className = 'exercise';
                            
                            // Tapping main area toggles complete
                            exDiv.onclick = (e) => {
                                // Don't toggle if clicking input
                                if (e.target.tagName === 'INPUT') return;
                                exDiv.classList.toggle('completed');
                            };

                            exDiv.innerHTML = `
                                <div class="ex-info">
                                    <div class="ex-header">
                                        <div class="ex-name">${ex.name}</div>
                                        <div class="ex-load">${ex.load || '-'}</div>
                                    </div>
                                    <div class="ex-details">
                                        ${ex.sets ? ex.sets + ' x ' : ''} ${ex.reps || ''} 
                                        ${ex.duration ? ' | ' + ex.duration : ''}
                                    </div>
                                    ${ex.notes ? `<div class="ex-notes">${ex.notes}</div>` : ''}
                                </div>
                                <div class="log-input-container">
                                    <input type="text" class="log-input" placeholder="#" data-name="${ex.name}" onclick="event.stopPropagation()">
                                    <div class="log-label">Log</div>
                                </div>
                            `;
                            content.appendChild(exDiv);
                        });
                    }

                    bDiv.appendChild(header);
                    bDiv.appendChild(content);
                    container.appendChild(bDiv);
                });
            }
        }

        // --- COPY LOGS ---
        function copyLogsToClipboard() {
            const inputs = document.querySelectorAll('.log-input');
            const date = document.getElementById('date-display').textContent;
            let logText = `My Results for ${date}:\n`;
            let hasLogs = false;

            inputs.forEach(input => {
                const val = input.value.trim();
                if (val !== "") {
                    logText += `- ${input.dataset.name}: ${val}\n`;
                    hasLogs = true;
                }
            });

            if (!hasLogs) {
                // If nothing logged, just confirm done
                logText += "Workout Complete (No specific weights logged).";
            }

            // Copy to clipboard
            navigator.clipboard.writeText(logText).then(() => {
                const btn = document.getElementById('copy-logs-btn');
                const originalHTML = btn.innerHTML;
                
                btn.innerHTML = "<span>‚úÖ</span> Copied!";
                btn.style.background = "#ffffff";
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = "var(--accent)";
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert("Could not copy text automatically. Please check permissions.");
            });
        }

        // --- TIMER LOGIC ---
        function startTimer(seconds) {
            const overlay = document.getElementById('timer-overlay');
            const display = document.getElementById('timer-display');
            overlay.style.display = 'flex';
            
            let remaining = seconds;
            
            // Update display immediately
            updateTimerDisplay(remaining);

            if (currentTimer) clearInterval(currentTimer);
            
            currentTimer = setInterval(() => {
                remaining--;
                updateTimerDisplay(remaining);
                if (remaining <= 0) {
                    clearInterval(currentTimer);
                    // Flash screen or sound could go here
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').textContent = `${m}:${s}`;
        }

        function closeTimer() {
            document.getElementById('timer-overlay').style.display = 'none';
            if (currentTimer) clearInterval(currentTimer);
        }
    </script>
</body>
</html>
